<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HouseLearning Quiz Mode</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?&family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://houselearning.github.io/feedback.js"></script>
  <script src="/cookiebanner.js"></script>
  <script src="/feedback.js"></script>
  <style>
    /* * Blooket-inspired Color Palette 
     * More vibrant and contrasting for a playful feel.
     */
    :root {
      --bg: #0d121c;           /* Deep dark blue */
      --card: #1a2233;         /* Slightly lighter, saturated card background */
      --text: #ffffff;         /* Pure white text for pop */
      --muted: #a3b3c9;        /* Lighter muted gray/blue */
      
      --primary: #4CAF50;      /* Bright Green (Success/Primary Action) */
      --primary-700: #388E3C;
      --accent-blue: #2196F3;  /* Blue (Information/Secondary Action) */
      --accent-orange: #FF9800; /* Orange (Highlight/Gold) */
      --danger: #F44336;       /* Red (Danger/Wrong) */
      --border: #334155;       /* Border color */
      --shadow-primary: 0 8px 15px rgba(76, 175, 80, 0.4);
      --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.5);
    }
    
    /* Global Styles */
    *{box-sizing:border-box}
    /* Use a linear gradient for the background to give depth */
    body{
      margin:0;
      font-family:'Inter', system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(145deg, var(--bg), #080c14);
      color:var(--text);
      min-height: 100vh;
    }
    
    /* Header (Sticky and Glassmorphism) */
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:1.25rem 2rem;
      border-bottom:1px solid var(--border);
      position:sticky;top:0;
      background:rgba(26,34,51,0.7); /* Slightly transparent card color */
      backdrop-filter:blur(10px);
      z-index:10;
      box-shadow: var(--shadow-card);
    }
    .brand{display:flex;align-items:center;gap:.75rem}
    .logo{
      width:44px;height:44px;border-radius:12px;
      /* More vibrant conic gradient */
      background:conic-gradient(from 180deg, var(--primary), var(--accent-blue), var(--accent-orange), var(--primary));
      box-shadow:0 0 20px rgba(76,175,80,.6);
      transform: rotate(-10deg);
      animation: logo-spin 10s linear infinite;
    }
    @keyframes logo-spin {
      from { transform: rotate(-10deg); }
      to { transform: rotate(350deg); }
    }
    h1{font-size:1.5rem;margin:0;font-weight:900;letter-spacing:-0.05em;color:var(--text)}
    
    /* Pill styling for info (e.g., Budget) */
    .pill{
      display:inline-flex;gap:.5rem;align-items:center;
      padding:.4rem .8rem;
      border:1px solid var(--border);
      border-radius:999px;
      background:var(--card); /* Match card background */
      color:var(--accent-orange); /* Use accent color for emphasis */
      font-weight: 700;
      box-shadow: 0 0 5px rgba(255, 152, 0, 0.3);
    }
    .user-info{display:flex;align-items:center;gap:.75rem}
    
    /* Main Container and Cards */
    .container{
      max-width:1300px;
      margin:1.75rem auto;
      padding:0 1.5rem;
      display:grid;
      grid-template-columns:240px 1fr; /* sidebar + content */
      gap:1.75rem;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px; /* More rounded corners */
      padding:1.5rem;
      box-shadow:var(--shadow-card);
      transition: all 0.3s ease;
    }
    .card:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
    }
    .card h2{
      margin-top:0;
      font-size:1.1rem;
      letter-spacing:.05em;
      color:var(--accent-blue);
      font-weight:800;
      text-transform:uppercase;
      border-bottom: 2px solid var(--border);
      padding-bottom: .5rem;
      margin-bottom: 1rem;
    }
    
    /* Form Elements */
    label{display:block;margin-bottom:.35rem;color:var(--muted);font-size:.9rem;font-weight:600}
    input,select,textarea{
      width:100%;
      padding:.75rem 1rem;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--bg); /* Darker input background */
      color:var(--text);
      outline:none;
      transition: border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--primary);
    }
    input::placeholder{color:#64748b}
    
    /* Primary Button (The "Blooket" button style) */
    button{
      cursor:pointer;
      background:var(--primary);
      border:none;
      font-weight:800;
      transition:transform .1s ease, background .2s ease, box-shadow .3s;
      box-shadow:var(--shadow-primary);
      padding: .75rem 1rem;
      border-radius: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    button:hover{background:var(--primary-700); box-shadow: 0 8px 20px rgba(76, 175, 80, 0.6);}
    button:active{transform:scale(.97); box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4);}
    
    /* Secondary/Muted Button */
    .btn-secondary{
      background:var(--card);
      border:1px solid var(--border);
      box-shadow:none;
      color: var(--text);
    }
    .btn-secondary:hover{background:#2b354d; border-color: var(--accent-blue); box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);}
    .btn-secondary:active{transform:scale(.97); box-shadow: none;}
    .muted{color:var(--muted);font-size:.9rem}
    .small{font-size:.85rem}
    
    /* Layouts */
    .grid{display:grid;gap:.85rem}
    .grid-2{grid-template-columns:1fr 1fr}
    .flex{display:flex;gap:.75rem;align-items:center}
    .space-between{display:flex;justify-content:space-between;align-items:center}
    .hidden{display:none!important}
    .divider{height:1px;background:var(--border);margin:.75rem 0}
    
    /* Quiz Item & Options */
    .quiz-item{
      border:2px solid var(--border); /* Thicker border */
      border-radius:14px;
      padding:1rem;
      background:var(--bg);
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.4);
    }
    .options{display:grid;gap:.6rem;margin-top:.75rem}
    .opt-btn{
      text-align:left;
      background:var(--card);
      border:2px solid var(--border);
      padding: 1rem 1.2rem;
      font-weight: 700;
      color: var(--text);
      transition: all 0.15s ease;
      box-shadow: none; /* Override default button shadow */
      text-transform: none; /* Keep option text natural case */
    }
    .opt-btn:hover {
      background: #2b354d;
      border-color: var(--accent-blue);
      transform: scale(1.01);
    }
    .opt-btn:active {
      transform: scale(0.99);
    }
    .opt-btn.correct{border-color:var(--primary); background: #388E3C; box-shadow: 0 0 15px rgba(76, 175, 80, 0.5); font-weight: 900;}
    .opt-btn.wrong{border-color:var(--danger); background: #962c2c; box-shadow: 0 0 15px rgba(244, 67, 54, 0.5); font-weight: 900;}

    /* Leaderboard */
    .leader-row{
      display:grid;
      grid-template-columns:1fr 120px 140px;
      gap:.75rem;
      padding:.7rem .5rem;
      border-bottom:1px dashed #334155;
      font-weight: 600;
    }
    .leader-row:first-child{
      color: var(--accent-orange);
      font-size: 1.1rem;
      font-weight: 900;
      border-bottom: 2px solid var(--accent-orange);
    }
    
    /* Modal (Keep clean) */
    .modal .sheet{width:min(520px,90vw)}
    
    /* Sidebar (new) */
    .side-nav {
      width: 240px;
      background: linear-gradient(180deg, rgba(26,34,51,0.95), rgba(26,34,51,0.95));
      border-right: 1px solid var(--border);
      padding: 1rem;
      border-radius: 0 18px 18px 0;
      position:sticky;
      top: calc(1.25rem + 1px); /* respect header spacing */
      height: calc(100vh - 2.5rem);
      overflow:auto;
      box-shadow: var(--shadow-card);
    }
    .side-nav .nav-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:.5rem}
    .side-nav .nav-item{
      display:flex;flex-direction:column;
      background:transparent;border-radius:10px;padding:.5rem;
      color:var(--text);cursor:pointer;border:1px solid transparent;
    }
    .side-nav .nav-item > .nav-link{
      display:flex;justify-content:space-between;align-items:center;gap:.5rem;padding:.45rem .6rem;
      font-weight:700;color:var(--muted);
    }
    .side-nav .nav-item:hover{ background: rgba(255,255,255,0.02); border-color: rgba(255,255,255,0.02); }
    .side-nav .nav-item.open > .nav-link{ color:var(--text); background: rgba(255,255,255,0.02); }
    .side-nav .submenu{
      max-height:0; overflow:hidden; transition: max-height .32s ease, padding .2s;
      padding:0 .5rem;
    }
    .side-nav .submenu.open{
      padding:.5rem;
      max-height:380px;
    }
    .side-nav .submenu button{
      width:100%;text-align:left;padding:.45rem .6rem;border-radius:8px;border:1px solid var(--border);
      background:var(--card);margin-bottom:.4rem;font-weight:700;color:var(--text);
    }

    /* Reduce cramped feeling: give main column more padding & update container columns */
    .container{
      max-width:1300px;
      margin:1.75rem auto;
      padding:0 1.5rem;
      display:grid;
      grid-template-columns:240px 1fr; /* sidebar + content */
      gap:1.75rem;
    }

    /* Ensure existing cards take full width of content column */
    .container > section.card{ width:100%; }

    /* Make sure overlay respects sidebar/spacing (no change if active) */
    /* ...existing code... */
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo"></div>
      <h1>HouseLearning Quiz Mode</h1>
      <span class="pill">üí∞ Budget: $0</span>
    </div>
    <div class="user-info">
      <button id="joinQuizTopBtn" title="Join by code">Join Quiz</button>

      <!-- Added login & theme toggle -->
      <button id="loginTopBtn" style="margin-left:.5rem">Sign in</button>
      <button id="themeToggleBtn" title="Toggle light/dark" class="btn-secondary" style="margin-left:.5rem">‚òÄÔ∏è/üåô</button>

      <span id="userEmail" class="muted">Not signed in</span>
      <button id="logoutBtn" class="btn-secondary hidden">Logout</button>
    </div>
  </header>

  <!-- Auth overlay that covers the page except the header -->
  <div id="authOverlay" aria-hidden="true">
    <div class="panel">
      <p style="font-weight:800">You're signed out. Sign in to learn.</p>
      <p class="muted">Sign in to build quizzes, host rooms, and join games.</p>
      <div style="display:flex;gap:.5rem;justify-content:center">
        <button id="overlaySignInBtn">Sign in</button>
      </div>
    </div>
  </div>

  <div id="joinModal" class="modal hidden">
    <div class="card sheet">
      <h2>Join quiz</h2>
      <label>Enter quiz code</label>
      <input id="joinCodeInput" type="text" placeholder="ABC12"/>
      <div class="flex">
        <button id="joinConfirmBtn">Join</button>
        <button id="joinCancelBtn" class="btn-secondary">Cancel</button>
      </div>
      <p id="joinFeedback" class="muted"></p>
    </div>
  </div>

  <!-- Added side navbar -->
  <aside class="side-nav" aria-label="Main navigation">
    <ul class="nav-list">
      <li class="nav-item" data-target="createSection">
        <div class="nav-link"><span>‚úèÔ∏è Create quiz</span><span>‚ñ∏</span></div>
        <div class="submenu">
          <button data-action="goto" data-target="createSection">Open Create</button>
          <button data-action="goto" data-target="myQuizzes">My Quizzes</button>
        </div>
      </li>

      <li class="nav-item" data-target="hostSection">
        <div class="nav-link"><span>üë®‚Äçüè´ Host room</span><span>‚ñ∏</span></div>
        <div class="submenu">
          <button data-action="goto" data-target="hostSection">Host Controls</button>
          <button data-action="goto" data-target="roomInfo">Room Info</button>
        </div>
      </li>

      <li class="nav-item" data-target="playArea">
        <div class="nav-link"><span>üéÆ Play</span><span>‚ñ∏</span></div>
        <div class="submenu">
          <button data-action="goto" data-target="playArea">Play locally</button>
          <button data-action="goto" data-target="quizSelect">Choose Quiz</button>
        </div>
      </li>

      <li class="nav-item" data-target="leaderboard">
        <div class="nav-link"><span>üèÜ Leaderboard</span><span>‚ñ∏</span></div>
        <div class="submenu">
          <button data-action="goto" data-target="leaderboard">View Leaderboard</button>
        </div>
      </li>

      <li class="nav-item">
        <div class="nav-link"><span>‚öôÔ∏è Settings</span><span>‚ñ∏</span></div>
        <div class="submenu">
          <button id="themeToggleSideBtn">Toggle theme</button>
          <button id="signOutSideBtn">Sign out</button>
        </div>
      </li>
    </ul>
  </aside>

  <main class="container">
    <section class="card">
      <h2>üîë Account & Setup</h2>
      <!-- Hide old side login inputs: now controlled by top button -->
      <div class="grid hidden" id="authSection">
        <div class="grid">
          <label>Email</label>
          <input id="email" type="email" placeholder="you@example.com" autocomplete="username"/>
        </div>
        <div class="grid">
          <label>Password</label>
          <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>
        </div>
        <div class="flex">
          <button id="loginBtn">Login</button>
          <button id="signupBtn" class="btn-secondary">Sign up</button>
        </div>
        <p class="muted">Sign in to build quizzes, host rooms, and join games.</p>
      </div>

      <div class="divider"></div>

      <h2>‚úèÔ∏è Create quiz</h2>
      <div id="createSection" class="grid hidden">
        <div class="grid">
          <label>Quiz title</label>
          <input id="quizTitle" type="text" placeholder="e.g., Algebra Basics"/>
        </div>
        <div class="grid">
          <label>Question</label>
          <textarea id="questionText" rows="2" placeholder="Enter your question..."></textarea>
        </div>
        <div class="grid grid-2">
          <div><label>Option A</label><input id="opt0" type="text" placeholder="Option A"/></div>
          <div><label>Option B</label><input id="opt1" type="text" placeholder="Option B"/></div>
          <div><label>Option C</label><input id="opt2" type="text" placeholder="Option C"/></div>
          <div><label>Option D</label><input id="opt3" type="text" placeholder="Option D"/></div>
        </div>
        <div class="grid">
          <label>Correct option</label>
          <select id="correctIndex">
            <option value="0">A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option>
          </select>
        </div>
        <div class="flex">
          <button id="addQuestionBtn">Add question</button>
          <button id="saveQuizBtn" class="btn-secondary">Save quiz</button>
        </div>
        <p id="createFeedback" class="muted"></p>
      </div>

      <div class="divider"></div>

      <h2>üìö Your quizzes</h2>
      <div id="myQuizzes" class="grid"></div>

      <div class="divider"></div>

      <h2>üë®‚Äçüè´ Host room</h2>
      <div id="hostSection" class="grid hidden">
        <label>Select a quiz</label>
        <select id="hostQuizSelect"></select>
        <label>Game mode</label>
        <select id="gameModeSelect">
          <option value="classic">Classic</option>
          <option value="gold">Gold Quest</option>
          <option value="battle">Battle Royale</option>
        </select>
        <div class="flex">
          <button id="createRoomBtn">Create room</button>
          <button id="endRoomBtn" class="btn-secondary hidden">End room</button>
        </div>
        <p class="muted small">Share the code with players. You can kick players and start the game.</p>

        <div id="roomInfo" class="quiz-item hidden">
          <div class="space-between">
            <div>
              <div style="font-weight:900; font-size: 1.2rem;">Room code: <span id="roomCodeText" style="color: var(--accent-orange);"></span></div>
              <div class="muted small">Status: <span id="roomStatusText">waiting</span> | Mode: <span id="roomModeText">classic</span></div>
            </div>
            <div class="flex">
              <button id="startRoomBtn">Start game</button>
            </div>
          </div>
          <div class="divider"></div>
          <div><strong>Players</strong></div>
          <div id="playersList" class="list"></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>üéÆ Play locally</h2>
      <div class="grid">
        <label>Choose quiz</label>
        <select id="quizSelect"></select>
        <div class="flex">
          <button id="startQuizBtn">Start</button>
          <button id="resetQuizBtn" class="btn-secondary">Reset</button>
        </div>
      </div>

      <div id="playArea" class="grid hidden">
        <div class="space-between">
          <div class="pill" style="color: var(--primary);">üéØ Score: <strong id="scoreVal">0</strong></div>
          <div class="pill" style="color: var(--accent-blue);"># Question <strong id="qIdx">0</strong>/<strong id="qTotal">0</strong></div>
        </div>
        <div id="questionCard" class="quiz-item">
          <div id="questionTitle" style="font-weight:900;margin-bottom:.8rem; font-size: 1.15rem; color: var(--accent-orange);"></div>
          <div id="questionTextView" class="muted" style="font-size: 1rem;"></div>
          <div id="optionsList" class="options"></div>
        </div>
        <div class="flex">
          <button id="nextBtn" class="btn-secondary">Next</button>
          <button id="finishBtn">Finish</button>
        </div>
        <p id="playFeedback" class="muted"></p>
      </div>

      <div class="divider"></div>

      <h2>üèÜ Leaderboard</h2>
      <div id="leaderboard" class="grid">
        <div class="leader-row" style="font-weight:700;"><div>Player</div><div>Best score</div><div>Quiz</div></div>
        <div id="leaderRows"></div>
      </div>
    </section>
  </main>

  <!-- Footer removed as requested -->
  <!-- ...existing code... (footer block removed) ... -->

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // The core Javascript logic remains unchanged as the request was purely aesthetic/CSS.
    // ... (All original JavaScript code here, untouched) ...
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDoXSwni65CuY1_32ZE8B1nwfQO_3VNpTw",
      authDomain: "contract-center-llc-10.firebaseapp.com",
      projectId: "contract-center-llc-10",
      storageBucket: "contract-center-llc-10.firebasestorage.app",
      messagingSenderId: "323221512767",
      appId: "1:323221512767:web:6421260f875997dbf64e8a",
      measurementId: "G-S2RJ0C6BWH"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Elements
    const emailEl = document.getElementById('email');
    const passwordEl = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userEmailEl = document.getElementById('userEmail');

    const createSection = document.getElementById('createSection');
    const quizTitleEl = document.getElementById('quizTitle');
    const questionTextEl = document.getElementById('questionText');
    const optInputs = [document.getElementById('opt0'), document.getElementById('opt1'), document.getElementById('opt2'), document.getElementById('opt3')];
    const correctIndexEl = document.getElementById('correctIndex');
    const addQuestionBtn = document.getElementById('addQuestionBtn');
    const saveQuizBtn = document.getElementById('saveQuizBtn');
    const createFeedbackEl = document.getElementById('createFeedback');
    const myQuizzesEl = document.getElementById('myQuizzes');

    const quizSelectEl = document.getElementById('quizSelect');
    const startQuizBtn = document.getElementById('startQuizBtn');
    const resetQuizBtn = document.getElementById('resetQuizBtn');
    const playAreaEl = document.getElementById('playArea');
    const scoreValEl = document.getElementById('scoreVal');
    const qIdxEl = document.getElementById('qIdx');
    const qTotalEl = document.getElementById('qTotal');
    const questionTitleEl = document.getElementById('questionTitle');
    const questionTextViewEl = document.getElementById('questionTextView');
    const optionsListEl = document.getElementById('optionsList');
    const nextBtn = document.getElementById('nextBtn');
    const finishBtn = document.getElementById('finishBtn');
    const playFeedbackEl = document.getElementById('playFeedback');

    const leaderRowsEl = document.getElementById('leaderRows');

    const hostSection = document.getElementById('hostSection');
    const hostQuizSelect = document.getElementById('hostQuizSelect');
    const gameModeSelect = document.getElementById('gameModeSelect');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const endRoomBtn = document.getElementById('endRoomBtn');
    const roomInfo = document.getElementById('roomInfo');
    const roomCodeText = document.getElementById('roomCodeText');
    const roomStatusText = document.getElementById('roomStatusText');
    const roomModeText = document.getElementById('roomModeText');
    const playersList = document.getElementById('playersList');
    const startRoomBtn = document.getElementById('startRoomBtn');

    const joinQuizTopBtn = document.getElementById('joinQuizTopBtn');
    const joinModal = document.getElementById('joinModal');
    const joinCodeInput = document.getElementById('joinCodeInput');
    const joinConfirmBtn = document.getElementById('joinConfirmBtn');
    const joinCancelBtn = document.getElementById('joinCancelBtn');
    const joinFeedback = document.getElementById('joinFeedback');

    // New elements
    const loginTopBtn = document.getElementById('loginTopBtn');
    const overlaySignInBtn = document.getElementById('overlaySignInBtn');
    const authOverlay = document.getElementById('authOverlay');
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const headerEl = document.querySelector('header');

    // Popup auth window handler
    let authPopup = null;
    let authPollInterval = null;
    const AUTH_URL = 'https://houselearning.github.io/auth';

    function openAuthPopup() {
      // Centered popup ~800x600
      const w = 820, h = 640;
      const left = (screen.width/2)-(w/2);
      const top = (screen.height/2)-(h/2);
      authPopup = window.open(AUTH_URL, 'HouseLearningAuth', `width=${w},height=${h},left=${left},top=${top}`);
      // Poll to detect navigation/closure. We'll also listen for postMessage from popup.
      if (authPollInterval) clearInterval(authPollInterval);
      const startHref = '';
      authPollInterval = setInterval(() => {
        try {
          if (!authPopup || authPopup.closed) {
            clearInterval(authPollInterval);
            authPollInterval = null;
            // popup closed: attempt reload to pick up auth state
            setTimeout(()=>location.reload(), 200);
            return;
          }
          // try read href (may throw cross-origin until the auth page redirects to same origin)
          const href = authPopup.location.href;
          // if href changed to include a callback token / or same-origin page that indicates finish, close
          if (href && href !== AUTH_URL) {
            // close & reload (best-effort)
            authPopup.close();
            clearInterval(authPollInterval);
            authPollInterval = null;
            setTimeout(()=>location.reload(), 150);
          }
        } catch (e) {
          // cross-origin: can't read yet ‚Äî rely on postMessage fallback
        }
      }, 600);
    }

    // Listen for messages from auth popup (if it posts one on completion)
    window.addEventListener('message', (ev) => {
      // Accept messages that indicate auth completed
      try {
        if (!ev.data) return;
        if (ev.data === 'houselearning:auth:success' || (ev.data && ev.data.type === 'houselearning:auth:success')) {
          if (authPopup && !authPopup.closed) authPopup.close();
          if (authPollInterval) { clearInterval(authPollInterval); authPollInterval = null; }
          setTimeout(()=>location.reload(), 150);
        }
      } catch (e) {}
    }, false);

    // Wire buttons to open auth popup
    loginTopBtn.addEventListener('click', openAuthPopup);
    overlaySignInBtn.addEventListener('click', openAuthPopup);

    // Show/hide overlay based on auth state. We also adjust overlay top to be below header.
    function updateAuthOverlay(show) {
      if (show) {
        // compute header height so overlay doesn't cover header
        const hdrH = headerEl.getBoundingClientRect().height || 68;
        authOverlay.style.top = hdrH + 'px';
        authOverlay.style.height = `calc(100% - ${hdrH}px)`;
        authOverlay.classList.add('show');
        authOverlay.setAttribute('aria-hidden','false');
      } else {
        authOverlay.classList.remove('show');
        authOverlay.setAttribute('aria-hidden','true');
      }
    }

    // Theme toggle persistence
    function applyTheme(theme) {
      if (theme === 'light') document.body.classList.add('light');
      else document.body.classList.remove('light');
      localStorage.setItem('hl_theme', theme);
    }
    // init theme
    const storedTheme = localStorage.getItem('hl_theme') || 'dark';
    applyTheme(storedTheme);
    themeToggleBtn.addEventListener('click', () => {
      const next = document.body.classList.contains('light') ? 'dark' : 'light';
      applyTheme(next);
    });

    // Modify auth.onAuthStateChanged to show overlay when not logged in & remove side login area
    auth.onAuthStateChanged(async (user) => {
      currentUser = user;
      if (user) {
        userEmailEl.textContent = user.email;
        logoutBtn.classList.remove('hidden');
        createSection.classList.remove('hidden');
        hostSection.classList.remove('hidden');
        updateAuthOverlay(false);
      } else {
        userEmailEl.textContent = 'Not signed in';
        logoutBtn.classList.add('hidden');
        createSection.classList.add('hidden');
        hostSection.classList.add('hidden');
        // show overlay blocking the app content (but not header)
        updateAuthOverlay(true);
      }
      refreshMyQuizzes();
      refreshQuizList();
      refreshHostQuizList();
    });

    // Ensure overlay fulfills initial sizing on resize
    window.addEventListener('resize', () => {
      if (authOverlay.classList.contains('show')) {
        const hdrH = headerEl.getBoundingClientRect().height || 68;
        authOverlay.style.top = hdrH + 'px';
        authOverlay.style.height = `calc(100% - ${hdrH}px)`;
      }
    });

    // Ensure logout cleans up room and then hides overlay accordingly (existing logout handler)
    logoutBtn.addEventListener('click', async () => {
      await leaveRoomIfJoined();
      await auth.signOut();
      // onAuthStateChanged will show overlay
    });

    // Create quiz
    addQuestionBtn.addEventListener('click', () => {
      const title = quizTitleEl.value.trim();
      const qText = questionTextEl.value.trim();
      const options = optInputs.map(i => i.value.trim());
      const correctIndex = parseInt(correctIndexEl.value, 10);
      if (!title) return createFeedbackEl.textContent = 'Add a quiz title.';
      if (!qText) return createFeedbackEl.textContent = 'Add a question.';
      if (options.some(o => !o)) return createFeedbackEl.textContent = 'Fill all options.';
      if (correctIndex < 0 || correctIndex > 3) return createFeedbackEl.textContent = 'Pick a valid correct option.';
      workingQuiz.title = title;
      workingQuiz.questions.push({ text: qText, options, correctIndex });
      questionTextEl.value = ''; optInputs.forEach(i => i.value=''); correctIndexEl.value='0';
      createFeedbackEl.textContent = `Added question #${workingQuiz.questions.length}.`;
    });

    saveQuizBtn.addEventListener('click', async () => {
      if (!currentUser) return alert('Sign in to save quizzes.');
      if (!workingQuiz.title || workingQuiz.questions.length === 0) return alert('Add at least one question.');
      try {
        const docRef = await db.collection('quizzes').add({
          title: workingQuiz.title, questions: workingQuiz.questions, ownerId: currentUser.uid,
          // use a concrete Timestamp instead of FieldValue.serverTimestamp()
          createdAt: firebase.firestore.Timestamp.now()
        });
        workingQuiz = { title: '', questions: [] }; quizTitleEl.value = ''; createFeedbackEl.textContent = 'Quiz saved!';
        refreshMyQuizzes(); refreshQuizList(); refreshHostQuizList();
        quizSelectEl.value = docRef.id;
      } catch (e) { alert(e.message); }
    });

    async function refreshMyQuizzes() {
      myQuizzesEl.innerHTML = '';
      const qs = await db.collection('quizzes')
        .where('ownerId', '==', currentUser ? currentUser.uid : '__none__')
        .orderBy('createdAt', 'desc').get();
      if (qs.empty) { myQuizzesEl.innerHTML = '<p class="muted">No quizzes yet.</p>'; return; }
      qs.forEach(doc => {
        const data = doc.data();
        const el = document.createElement('div');
        el.className = 'quiz-item';
        el.innerHTML = `
          <div class="space-between">
            <div><div style="font-weight:700">${data.title}</div><div class="muted">${data.questions?.length || 0} questions</div></div>
            <div class="flex">
              <button class="btn-secondary small" data-id="${doc.id}" data-action="preview">Preview</button>
              <button class="btn-secondary small" data-id="${doc.id}" data-action="delete">Delete</button>
            </div>
          </div>`;
        el.addEventListener('click', async (evt) => {
          const id = evt.target.getAttribute('data-id');
          const action = evt.target.getAttribute('data-action');
          if (!id || !action) return;
          if (action === 'delete') { if (!confirm('Delete this quiz?')) return; await db.collection('quizzes').doc(id).delete(); refreshMyQuizzes(); refreshQuizList(); refreshHostQuizList(); }
          if (action === 'preview') { const snap = await db.collection('quizzes').doc(id).get(); const q = snap.data(); alert(`${q.title}\n\n${q.questions.map((qq,i)=>`${i+1}. ${qq.text}`).join('\n')}`); }
        });
        myQuizzesEl.appendChild(el);
      });
    }

    // Local play
    startQuizBtn.addEventListener('click', async () => {
      selectedQuizId = quizSelectEl.value;
      if (!selectedQuizId) return alert('Select a quiz.');
      const snap = await db.collection('quizzes').doc(selectedQuizId).get();
      currentQuiz = { id: snap.id, ...snap.data() };
      currentQuizQuestions = shuffle([...currentQuiz.questions]);
      qIndex = 0; score = 0;
      qTotalEl.textContent = currentQuizQuestions.length; scoreValEl.textContent = score.toString();
      playAreaEl.classList.remove('hidden'); renderQuestion(); playFeedbackEl.textContent = 'Good luck!';
    });

    resetQuizBtn.addEventListener('click', () => {
      selectedQuizId = null; quizSelectEl.value = '';
      playAreaEl.classList.add('hidden'); optionsListEl.innerHTML=''; questionTextViewEl.textContent=''; questionTitleEl.textContent='';
      playFeedbackEl.textContent=''; scoreValEl.textContent='0'; qIdxEl.textContent='0'; qTotalEl.textContent='0';
    });

    nextBtn.addEventListener('click', () => { if (!currentQuizQuestions.length) return;
      qIndex = Math.min(qIndex + 1, currentQuizQuestions.length - 1); renderQuestion(); playFeedbackEl.textContent=''; });

    finishBtn.addEventListener('click', async () => {
      playFeedbackEl.textContent = `Finished! Score: ${score}/${currentQuizQuestions.length}.`;
      if (currentUser && currentQuiz) {
        const entryKey = `${currentUser.uid}_${currentQuiz.id}`;
        const ref = db.collection('leaderboard').doc(entryKey);
        const snap = await ref.get();
        if (!snap.exists) {
          await ref.set({ userId: currentUser.uid, userEmail: currentUser.email, quizId: currentQuiz.id, quizTitle: currentQuiz.title, bestScore: score, attempts: 1, updatedAt: firebase.firestore.Timestamp.now() });
        } else {
          const prev = snap.data();
          await ref.update({ bestScore: Math.max(prev.bestScore || 0, score), attempts: (prev.attempts || 0) + 1, quizTitle: currentQuiz.title, updatedAt: firebase.firestore.Timestamp.now() });
        }
        loadLeaderboard();
      }
    });

    function renderQuestion() {
      const q = currentQuizQuestions[qIndex];
      qIdxEl.textContent = (qIndex + 1).toString();
      questionTitleEl.textContent = currentQuiz.title || 'Quiz';
      questionTextViewEl.textContent = q.text;
      optionsListEl.innerHTML = '';
      q.options.forEach((opt, i) => {
        const b = document.createElement('button');
        b.className = 'opt-btn';
        b.textContent = `${String.fromCharCode(65+i)}. ${opt}`;
        b.addEventListener('click', () => {
          const correct = q.correctIndex === i;
          if (correct) { score += 1; scoreValEl.textContent = score.toString(); }
          Array.from(optionsListEl.children).forEach((btn, idx) => { btn.classList.remove('correct','wrong'); if (idx === q.correctIndex) btn.classList.add('correct'); });
          b.classList.add(correct ? 'correct' : 'wrong');
          playFeedbackEl.textContent = correct ? 'Correct!' : 'Try again next time.';
        });
        optionsListEl.appendChild(b);
      });
    }

    async function refreshQuizList() {
      const qs = await db.collection('quizzes').orderBy('createdAt', 'desc').get();
      quizSelectEl.innerHTML = `<option value="">Select a quiz...</option>`;
      qs.forEach(doc => {
        const data = doc.data();
        const opt = document.createElement('option');
        opt.value = doc.id; opt.textContent = `${data.title} (${data.questions?.length || 0} q)`;
        quizSelectEl.appendChild(opt);
      });
    }

    async function refreshHostQuizList() {
      const qs = await db.collection('quizzes').orderBy('createdAt', 'desc').get();
      hostQuizSelect.innerHTML = `<option value="">Select a quiz...</option>`;
      qs.forEach(doc => {
        const data = doc.data();
        const opt = document.createElement('option');
        opt.value = doc.id; opt.textContent = `${data.title} (${data.questions?.length || 0} q)`;
        hostQuizSelect.appendChild(opt);
      });
    }

    async function loadLeaderboard() {
      leaderRowsEl.innerHTML = '';
      const qs = await db.collection('leaderboard').orderBy('bestScore', 'desc').limit(25).get();
      if (qs.empty) { leaderRowsEl.innerHTML = `<div class="muted" style="padding:.5rem;">No scores yet.</div>`; return; }
      qs.forEach(doc => {
        const d = doc.data();
        const row = document.createElement('div');
        row.className = 'leader-row';
        row.innerHTML = `<div>${d.userEmail || d.userId}</div><div>${d.bestScore}</div><div>${d.quizTitle || d.quizId}</div>`;
        leaderRowsEl.appendChild(row);
      });
    }

    // Modal handlers (Join Quiz)
    joinQuizTopBtn.addEventListener('click', () => { joinModal.classList.remove('hidden'); joinFeedback.textContent=''; });
    joinCancelBtn.addEventListener('click', () => { joinModal.classList.add('hidden'); });
    joinConfirmBtn.addEventListener('click', async () => {
      const code = joinCodeInput.value.trim().toUpperCase();
      if (!code) return joinFeedback.textContent = 'Enter a valid code.';
      if (!currentUser) return joinFeedback.textContent = 'Sign in first.';
      const roomRef = db.collection('rooms').doc(code);
      const snap = await roomRef.get();
      if (!snap.exists) { joinFeedback.textContent = 'Room not found.'; return; }
      const data = snap.data();
      if (data.status === 'finished') { joinFeedback.textContent = 'Game already finished.'; return; }
      await roomRef.update({
        [`players.${currentUser.uid}`]: {
          email: currentUser.email, gold: 0, score: 0, alive: true,
          // avoid FieldValue.serverTimestamp()
          joinedAt: firebase.firestore.Timestamp.now()
        }
      });
      currentRoomCode = code;
      subscribeRoom(code);
      joinModal.classList.add('hidden');
      alert('Joined room ' + code + '. Wait for host to start.');
    });

    async function leaveRoomIfJoined() {
      if (!currentRoomCode || !currentUser) return;
      const roomRef = db.collection('rooms').doc(currentRoomCode);
      try {
        await roomRef.update({ [`players.${currentUser.uid}`]: firebase.firestore.FieldValue.delete() });
      } catch (_) {}
      if (roomUnsub) { roomUnsub(); roomUnsub = null; }
      currentRoomCode = null; roomData = null;
    }

    // Host room creation
    createRoomBtn.addEventListener('click', async () => {
      if (!currentUser) return alert('Sign in to host.');
      const quizId = hostQuizSelect.value;
      const mode = gameModeSelect.value;
      if (!quizId) return alert('Select a quiz to host.');
      const code = Math.random().toString(36).substring(2, 7).toUpperCase();
      await db.collection('rooms').doc(code).set({
        hostId: currentUser.uid, quizId, mode, status: 'waiting',
        players: {}, createdAt: firebase.firestore.Timestamp.now()
      });
      currentRoomCode = code;
      roomCodeText.textContent = code; roomModeText.textContent = mode; roomStatusText.textContent = 'waiting';
      roomInfo.classList.remove('hidden'); endRoomBtn.classList.remove('hidden');
      subscribeRoom(code);
      alert('Room created! Code: ' + code);
    });

    endRoomBtn.addEventListener('click', async () => {
      if (!currentRoomCode) return;
      const roomRef = db.collection('rooms').doc(currentRoomCode);
      await roomRef.update({ status: 'finished' });
      if (roomUnsub) { roomUnsub(); roomUnsub = null; }
      currentRoomCode = null; roomInfo.classList.add('hidden'); endRoomBtn.classList.add('hidden');
      playersList.innerHTML = '';
    });

    startRoomBtn.addEventListener('click', async () => {
      if (!currentRoomCode) return;
      const roomRef = db.collection('rooms').doc(currentRoomCode);
      await roomRef.update({ status: 'started', round: 1 });
      alert('Game started!');
    });

    // Subscribe to room changes
    function subscribeRoom(code) {
      if (roomUnsub) roomUnsub();
      roomUnsub = db.collection('rooms').doc(code).onSnapshot(async (snap) => {
        if (!snap.exists) return;
        roomData = snap.data();
        // Update host panel UI
        roomStatusText.textContent = roomData.status;
        roomModeText.textContent = roomData.mode;
        renderPlayers(roomData);
        // If started and user is a player, pull quiz and render question by mode
        if (roomData.status === 'started') {
          const qSnap = await db.collection('quizzes').doc(roomData.quizId).get();
          const quiz = qSnap.data();
          if (quiz) driveGameLoop(roomData, quiz);
        }
      });
    }

    function renderPlayers(room) {
      playersList.innerHTML = '';
      const entries = Object.entries(room.players || {});
      entries.forEach(([uid, info]) => {
        const row = document.createElement('div');
        row.className = 'player-row';
        row.innerHTML = `
          <div>
            <div style="font-weight:600">${info.email || uid}</div>
            <div class="muted small">
              ${room.mode === 'gold' ? `Gold: ${info.gold || 0}` : room.mode === 'classic' ? `Score: ${info.score || 0}` : `Alive: ${info.alive !== false}`}
            </div>
          </div>
          <div class="flex">
            <button class="btn-secondary small" data-uid="${uid}" data-action="kick">Kick</button>
          </div>`;
        // Kick only visible to host
        if (!currentUser || room.hostId !== currentUser.uid) {
          row.querySelector('[data-action="kick"]').classList.add('hidden');
        }
        row.addEventListener('click', async (e) => {
          const action = e.target.getAttribute('data-action');
          const uid = e.target.getAttribute('data-uid');
          if (action === 'kick' && currentUser && room.hostId === currentUser.uid) {
            await db.collection('rooms').doc(currentRoomCode).update({
              [`players.${uid}`]: firebase.firestore.FieldValue.delete()
            });
          }
        });
        playersList.appendChild(row);
      });
    }

    // Game loop driver (simplified per mode)
    let lastDrivenRound = 0;
    async function driveGameLoop(room, quiz) {
      // Prevent rerender for same round
      const round = room.round || 1;
      if (lastDrivenRound === round) return;
      lastDrivenRound = round;

      // For simplicity: everyone advances same question index = round-1
      const qIdxRoom = Math.min(round - 1, (quiz.questions || []).length - 1);
      const q = quiz.questions[qIdxRoom];
      if (!q) return;

      // Render a lightweight in-room question UI via alert prompts (MVP)
      // In production, you'd render a proper room play area. Here we reuse local play card:
      questionTitleEl.textContent = `${quiz.title} (Room ${currentRoomCode}, ${room.mode})`;
      questionTextViewEl.textContent = q.text;
      optionsListEl.innerHTML = '';
      playAreaEl.classList.remove('hidden');
      qTotalEl.textContent = (quiz.questions || []).length;
      qIdxEl.textContent = (qIdxRoom + 1).toString();

      q.options.forEach((opt, i) => {
        const b = document.createElement('button');
        b.className = 'opt-btn';
        b.textContent = `${String.fromCharCode(65+i)}. ${opt}`;
        b.addEventListener('click', async () => {
          const correct = q.correctIndex === i;
          // Apply mode scoring
          if (room.mode === 'classic') {
            await db.collection('rooms').doc(currentRoomCode).update({
              [`players.${currentUser.uid}.score`]: firebase.firestore.FieldValue.increment(correct ? 1 : 0)
            });
            playFeedbackEl.textContent = correct ? 'Correct (+1 score).' : 'Wrong.';
          } else if (room.mode === 'gold') {
            await handleGoldAnswer(currentRoomCode, currentUser.uid, correct);
            playFeedbackEl.textContent = correct ? 'Gold event occurred!' : 'Wrong.';
          } else if (room.mode === 'battle') {
            await db.collection('rooms').doc(currentRoomCode).update({
              [`players.${currentUser.uid}.alive`]: correct ? true : false
            });
            playFeedbackEl.textContent = correct ? 'You survived.' : 'Eliminated.';
          }
          // Move to next round (host controls flow; MVP auto-advance)
          if (currentUser && room.hostId === currentUser.uid) {
            await db.collection('rooms').doc(currentRoomCode).update({ round: round + 1 });
          }
        });
        optionsListEl.appendChild(b);
      });
    }

    // Gold Quest helpers
    function goldEvent() {
      const roll = Math.random();
      if (roll < 0.6) return { type: "gold", amount: Math.floor(Math.random()*10)+1 };
      if (roll < 0.8) return { type: "steal" };
      return { type: "nothing" };
    }

    async function handleGoldAnswer(roomCode, uid, correct) {
      if (!correct) return;
      const event = goldEvent();
      const roomRef = db.collection("rooms").doc(roomCode);
      if (event.type === "gold") {
        await roomRef.update({ [`players.${uid}.gold`]: firebase.firestore.FieldValue.increment(event.amount) });
      } else if (event.type === "steal") {
        const snap = await roomRef.get();
        const players = snap.data().players || {};
        const others = Object.keys(players).filter(id => id !== uid);
        const victimUid = others[Math.floor(Math.random() * Math.max(others.length, 1))];
        if (victimUid) {
          const stealAmt = Math.min(players[victimUid].gold || 0, 5);
          await roomRef.update({
            [`players.${uid}.gold`]: firebase.firestore.FieldValue.increment(stealAmt),
            [`players.${victimUid}.gold`]: firebase.firestore.FieldValue.increment(-stealAmt)
          });
        }
      }
      // nothing event: no-op
    }

    // Utils
    function shuffle(arr) { for (let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

    // Initial loads
    refreshQuizList();
    refreshHostQuizList();
    loadLeaderboard();

    // Side nav interactions (toggle dropdowns and smooth goto)
    (function(){
      const navItems = document.querySelectorAll('.side-nav .nav-item');
      navItems.forEach(item => {
        const link = item.querySelector('.nav-link');
        const submenu = item.querySelector('.submenu');
        link.addEventListener('click', () => {
          const isOpen = item.classList.toggle('open');
          if (submenu) submenu.classList.toggle('open', isOpen);
        });
      });

      // handle submenu button actions (smooth scroll / show sections)
      document.querySelector('.side-nav').addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action="goto"]');
        if (!btn) return;
        const targetId = btn.getAttribute('data-target');
        const el = document.getElementById(targetId);
        if (el) {
          el.scrollIntoView({behavior:'smooth', block:'start'});
          // briefly pulse target to draw attention
          el.animate([{boxShadow:'0 0 0 rgba(0,0,0,0)'},{boxShadow:'0 0 20px rgba(255,160,80,0.18)'}],{duration:400,iterations:1});
        }
      });

      // hook theme toggle in sidebar to existing theme function
      const themeSideBtn = document.getElementById('themeToggleSideBtn');
      if (themeSideBtn) themeSideBtn.addEventListener('click', () => {
        const next = document.body.classList.contains('light') ? 'dark' : 'light';
        applyTheme(next);
      });

      // sign out button in sidebar
      const signOutSideBtn = document.getElementById('signOutSideBtn');
      if (signOutSideBtn) signOutSideBtn.addEventListener('click', async () => {
        await leaveRoomIfJoined();
        await auth.signOut();
      });
    })();
  </script>
</body>
</html>
